<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Seedbringer Rhythmind Interface — App</title>
  <style>
    body { font-family: Arial, sans-serif; margin:20px; }
    #messages { height:300px; border:1px solid #ddd; padding:8px; overflow:auto; white-space: pre-wrap; }
    #controls { margin-top:10px; }
  </style>
</head>
<body>
  <h3>Seedbringer Rhythmind Interface — App</h3>
  <div id="status">Checking auth...</div>
  <div id="controls" style="display:none">
    <div id="messages"></div>
    <input id="msg" placeholder="message" />
    <button id="send">Send</button>
  </div>
  <script>
    async function init() {
      const me = await fetch('/me').then(r => r.json());
      if (!me.authenticated) {
        document.getElementById('status').innerHTML = '<a href="/auth/google">Sign in with Google</a>';
        return;
      }
      document.getElementById('status').textContent = 'Signed in as ' + me.user.email;
      document.getElementById('controls').style.display = 'block';

      function getCookie(name) {
        const v = document.cookie.match('(^|;)\s*' + name + '\s*=\s*([^;]+)');
        return v ? v.pop() : '';
      }
      const token = getCookie('sb_token');
      const wsProto = location.protocol === 'https:' ? 'wss' : 'ws';
      const ws = new WebSocket(wsProto + '://' + location.host + '/?token=' + encodeURIComponent(token));
      const messages = document.getElementById('messages');

      ws.onopen = () => messages.appendChild(document.createTextNode('[connected]\n'));
      ws.onmessage = (ev) => {
        const obj = JSON.parse(ev.data);
        const line = document.createElement('div');
        line.textContent = `${obj.ts} — ${obj.from}: ${JSON.stringify(obj.payload)}`;
        messages.appendChild(line);
      };

      document.getElementById('send').onclick = () => {
        const v = document.getElementById('msg').value;
        ws.send(JSON.stringify({ type: 'message', payload: v }));
        document.getElementById('msg').value = '';
      };
    }
    init();
  </script>
</body>
</html>